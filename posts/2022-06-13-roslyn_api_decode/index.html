<!doctype html><html lang=zh-tw><head><title>Roslyn API 練習 // 派翠克技術手札</title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.81.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Patrick"><meta name=description content="假設我有個 CSharp 程式碼檔案，我想要用寫程式來解析裡面的東西，這件事情就是C# Compile做的事情，微軟提供Roslyn API供我們來解析程式碼，今天來做個小練習，沒有什麼功用，利用 Roslyn API解析程式碼，並重新輸出程式碼。"><link rel=stylesheet href=https://patrick85081.github.io/css/main.min.88e7083eff65effb7485b6e6f38d10afbec25093a6fac42d734ce9024d3defbd.css><meta name=twitter:card content="summary"><meta name=twitter:title content="Roslyn API 練習"><meta name=twitter:description content="假設我有個 CSharp 程式碼檔案，我想要用寫程式來解析裡面的東西，這件事情就是C# Compile做的事情，微軟提供Roslyn API供我們來解析程式碼，今天來做個小練習，沒有什麼功用，利用 Roslyn API解析程式碼，並重新輸出程式碼。"><meta property="og:title" content="Roslyn API 練習"><meta property="og:description" content="假設我有個 CSharp 程式碼檔案，我想要用寫程式來解析裡面的東西，這件事情就是C# Compile做的事情，微軟提供Roslyn API供我們來解析程式碼，今天來做個小練習，沒有什麼功用，利用 Roslyn API解析程式碼，並重新輸出程式碼。"><meta property="og:type" content="article"><meta property="og:url" content="https://patrick85081.github.io/posts/2022-06-13-roslyn_api_decode/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-13T14:11:46+08:00"><meta property="article:modified_time" content="2022-06-13T14:11:46+08:00"></head><body><header class=app-header><a href=https://patrick85081.github.io/><img class=app-header-avatar src=/avatar.png alt=Patrick></a><h1>派翠克技術手札</h1><nav class=app-header-menu><a class=app-header-menu-item href=/>首頁</a>
-
<a class=app-header-menu-item href=/tags/>標籤</a>
-
<a class=app-header-menu-item href=/search/>文章搜尋</a></nav><p>這裡是派翠克的技術手札</p><div class=app-header-social><a href=https://github.com/patrick85081 target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>Github</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=/index.xml target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-rss"><title>Rss</title><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a><a href=mailto:patrick85081@gmail.com target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-mail"><title>聯絡我</title><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>Roslyn API 練習</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2022-06-13, Monday</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>3 min read</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><a class=tag href=https://patrick85081.github.io/tags/roslyn/>Roslyn</a></div></div></header><div class=post-content><h1 id=前言>前言</h1><p>假設我有個 CSharp 程式碼檔案，我想要用寫程式來解析裡面的東西，這件事情就是C# Compile做的事情，微軟提供Roslyn API供我們來解析程式碼，今天來做個沒有什麼功用的小練習，利用 Roslyn API解析程式碼，並重新輸出程式碼。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#66d9ef>using</span> System;
<span style=color:#66d9ef>using</span> System.Collections.Generic;
<span style=color:#66d9ef>using</span> System.ComponentModel;
<span style=color:#66d9ef>using</span> System.Linq;
<span style=color:#66d9ef>using</span> System.Threading.Tasks;

<span style=color:#66d9ef>namespace</span> SyntaxAnalysisTest
{
    <span style=color:#75715e>/// &lt;summary&gt;
</span><span style=color:#75715e></span>    <span style=color:#75715e>/// 為賦新詞強說愁
</span><span style=color:#75715e></span>    <span style=color:#75715e>/// &lt;/summary&gt;
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> IMyService
    {
        <span style=color:#75715e>/// &lt;summary&gt;
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// 隨機產生 GUID
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// &lt;/summary&gt;
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// &lt;returns&gt;GUID&lt;/returns&gt;
</span><span style=color:#75715e></span>        Guid GetGuid();

        <span style=color:#75715e>/// &lt;summary&gt;
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// 產生指定數量的隨機數
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// &lt;/summary&gt;
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// &lt;param name=&#34;count&#34;&gt;數量&lt;/param&gt;
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// &lt;returns&gt;隨機數陣列&lt;/returns&gt;
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>int</span>[] GenRandNumbers(<span style=color:#66d9ef>int</span> count);

        <span style=color:#75715e>/// &lt;summary&gt;
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// 複雜參數
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// &lt;/summary&gt;
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// &lt;param name=&#34;ints&#34;&gt;整數陣列&lt;/param&gt;
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// &lt;param name=&#34;mapping&#34;&gt;對照表&lt;/param&gt;
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// &lt;param name=&#34;args&#34;&gt;不定數量參數&lt;/param&gt;
</span><span style=color:#75715e></span><span style=color:#a6e22e>        [Description(&#34;TEST&#34;)]</span>
        <span style=color:#66d9ef>void</span> Complex(List&lt;<span style=color:#66d9ef>int</span>&gt; ints, Dictionary&lt;<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>string</span>&gt; mapping = <span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>params</span> <span style=color:#66d9ef>string</span>[] args);
    }

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyService</span> : IMyService
    {
        <span style=color:#75715e>/// &lt;summary&gt;
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// 隨機產生 GUID
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// &lt;/summary&gt;
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// &lt;returns&gt;GUID&lt;/returns&gt;
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>public</span> Guid GetGuid() =&gt; Guid.NewGuid();
        <span style=color:#75715e>/// &lt;summary&gt;
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// 產生指定數量的隨機數
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// &lt;/summary&gt;
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// &lt;param name=&#34;count&#34;&gt;數量&lt;/param&gt;
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// &lt;returns&gt;隨機數陣列&lt;/returns&gt;
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span>[] GenRandNumbers(<span style=color:#66d9ef>int</span> count) =&gt; <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>int</span>[]{<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>};
        <span style=color:#75715e>/// &lt;summary&gt;
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// 複雜參數
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// &lt;/summary&gt;
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// &lt;param name=&#34;ints&#34;&gt;整數陣列&lt;/param&gt;
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// &lt;param name=&#34;mapping&#34;&gt;對照表&lt;/param&gt;
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// &lt;param name=&#34;args&#34;&gt;不定數量參數&lt;/param&gt;
</span><span style=color:#75715e></span><span style=color:#a6e22e>        [Description(&#34;TEST&#34;)]</span>
        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> Complex(List&lt;<span style=color:#66d9ef>int</span>&gt; ints, Dictionary&lt;<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>string</span>&gt; mapping = <span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>params</span> <span style=color:#66d9ef>string</span>[] args) {}
    }
}
</code></pre></div><h1 id=寫個小練習>寫個小練習</h1><p>這裡寫個遞回，把Roslyn API 解析出來的節點輸出回程式碼</p><p>Roslyn提供Syntax Tree表達樹，裡面的種類</p><ul><li>Syntax Node
宣告（類別、介面）、子句、表達式等等</li><li>Syntax Token
子節點，包含 keyword name 符號等等程式碼元素</li><li>Syntax Trivia
空白、換行、註解 等等</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#66d9ef>using</span> Microsoft.CodeAnalysis;
<span style=color:#66d9ef>using</span> Microsoft.CodeAnalysis.CSharp;

<span style=color:#66d9ef>var</span> code = File.ReadAllText(<span style=color:#e6db74>&#34;IMyService.txt&#34;</span>);

<span style=color:#66d9ef>var</span> tree = CSharpSyntaxTree.ParseText(code);
<span style=color:#66d9ef>var</span> root = tree.GetCompilationUnitRoot();

OutputCode(root.ChildNodesAndTokens());


<span style=color:#66d9ef>void</span> OutputCode(IEnumerable&lt;SyntaxNodeOrToken&gt; children)
{
    <span style=color:#66d9ef>var</span> n = <span style=color:#66d9ef>false</span>;
    OutputCodeImpl(children, <span style=color:#66d9ef>ref</span> n, <span style=color:#ae81ff>0</span>);
}

<span style=color:#66d9ef>void</span> OutputCodeImpl(IEnumerable&lt;SyntaxNodeOrToken&gt; children, <span style=color:#66d9ef>ref</span> <span style=color:#66d9ef>bool</span> isNewLine, <span style=color:#66d9ef>int</span> tabCount)
{
    <span style=color:#66d9ef>foreach</span> (<span style=color:#66d9ef>var</span> child <span style=color:#66d9ef>in</span> children)
    {
        <span style=color:#66d9ef>if</span> (!child.IsToken)
        {
            OutputCodeImpl(child.ChildNodesAndTokens(), <span style=color:#66d9ef>ref</span> isNewLine, tabCount);
            <span style=color:#66d9ef>continue</span>;
        }

        <span style=color:#66d9ef>if</span> (child.Kind() == SyntaxKind.EndOfFileToken)
            <span style=color:#66d9ef>return</span>;

        <span style=color:#66d9ef>var</span> txt = child.Kind() <span style=color:#66d9ef>switch</span>
        {
            SyntaxKind.UsingKeyword =&gt; <span style=color:#e6db74>&#34;using&#34;</span>,
            SyntaxKind.SemicolonToken =&gt; <span style=color:#e6db74>&#34;;&#34;</span>,
            SyntaxKind.IdentifierToken =&gt; child.ToString(),
            SyntaxKind.DotToken =&gt; <span style=color:#e6db74>&#34;.&#34;</span>,
            SyntaxKind.NamespaceKeyword =&gt; <span style=color:#e6db74>&#34;namespace&#34;</span>,
            SyntaxKind.OpenBraceToken =&gt; <span style=color:#e6db74>&#34;{&#34;</span>,
            SyntaxKind.CloseBraceToken =&gt; <span style=color:#e6db74>&#34;}&#34;</span>,
            SyntaxKind.PublicKeyword =&gt; <span style=color:#e6db74>&#34;public&#34;</span>,
            SyntaxKind.InterfaceKeyword =&gt; <span style=color:#e6db74>&#34;interface&#34;</span>,
            SyntaxKind.ClassKeyword =&gt; <span style=color:#e6db74>&#34;class&#34;</span>,
            SyntaxKind.ColonToken =&gt; <span style=color:#e6db74>&#34;:&#34;</span>,
            SyntaxKind.OpenParenToken =&gt; <span style=color:#e6db74>&#34;(&#34;</span>,
            SyntaxKind.CloseParenToken =&gt; <span style=color:#e6db74>&#34;)&#34;</span>,
            SyntaxKind.VoidKeyword =&gt; <span style=color:#e6db74>&#34;void&#34;</span>,
            SyntaxKind.IntKeyword =&gt; <span style=color:#e6db74>&#34;int&#34;</span>,
            SyntaxKind.OpenBracketToken =&gt; <span style=color:#e6db74>&#34;[&#34;</span>,
            SyntaxKind.CloseBracketToken =&gt; <span style=color:#e6db74>&#34;]&#34;</span>,
            SyntaxKind.ParamsKeyword =&gt; <span style=color:#e6db74>&#34;params&#34;</span>,
            SyntaxKind.StringKeyword =&gt; <span style=color:#e6db74>&#34;string&#34;</span>,
            SyntaxKind.NullKeyword =&gt; <span style=color:#e6db74>&#34;null&#34;</span>,
            SyntaxKind.CommaToken =&gt; <span style=color:#e6db74>&#34;,&#34;</span>,
            SyntaxKind.NewKeyword =&gt; <span style=color:#e6db74>&#34;new&#34;</span>,
            SyntaxKind.StringLiteralToken =&gt; child.ToString(),
            SyntaxKind.OmittedArraySizeExpressionToken =&gt; child.ToString(),
            SyntaxKind.EqualsGreaterThanToken =&gt; <span style=color:#e6db74>&#34;=&gt;&#34;</span>,
            SyntaxKind.List =&gt; <span style=color:#e6db74>&#34;List&#34;</span>,
            SyntaxKind.LessThanToken =&gt; <span style=color:#e6db74>&#34;&lt;&#34;</span>,
            SyntaxKind.GreaterThanToken =&gt; <span style=color:#e6db74>&#34;&gt;&#34;</span>,
            SyntaxKind.NumericLiteralToken =&gt; child.ToString(),
            SyntaxKind.EqualsToken =&gt; <span style=color:#e6db74>&#34;=&#34;</span>,
            _ =&gt; <span style=color:#e6db74>$&#34;*{child.Kind()}*&#34;</span>,
        };

        <span style=color:#75715e>// {
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (child.Kind() == SyntaxKind.CloseBraceToken)
            tabCount -= <span style=color:#ae81ff>1</span>;

        <span style=color:#75715e>// \t
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (isNewLine)
        {
            isNewLine = <span style=color:#66d9ef>false</span>;
            <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i = <span style=color:#ae81ff>1</span>; i &lt;= tabCount; i++)
                Console.Write(<span style=color:#e6db74>&#34;\t&#34;</span>);
        }

        Console.Write(txt);
        
        <span style=color:#75715e>// }
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (child.Kind() == SyntaxKind.OpenBraceToken)
            tabCount += <span style=color:#ae81ff>1</span>;


        SyntaxTriviaList syntaxTriviaList = child.GetTrailingTrivia();
        <span style=color:#66d9ef>foreach</span> (<span style=color:#66d9ef>var</span> syntaxTrivia <span style=color:#66d9ef>in</span> syntaxTriviaList)
        {
            <span style=color:#66d9ef>var</span> kind = syntaxTrivia.Kind();
            <span style=color:#75715e>// &#34; &#34;
</span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> (syntaxTrivia.Kind() == SyntaxKind.WhitespaceTrivia)
            {
                Console.Write(<span style=color:#e6db74>&#34; &#34;</span>);
            }
            <span style=color:#75715e>// \r\n
</span><span style=color:#75715e></span>            <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (syntaxTrivia.Kind() == SyntaxKind.EndOfLineTrivia)
            {
                Console.WriteLine();
                isNewLine = <span style=color:#66d9ef>true</span>;
            }
            <span style=color:#66d9ef>else</span>
            {
                <span style=color:#75715e>// 尚未實作的種類
</span><span style=color:#75715e></span>                Console.WriteLine(<span style=color:#e6db74>$&#34;*{syntaxTrivia.Kind()}*&#34;</span>);
            }
        }
    }
}
</code></pre></div><p>得到輸出結果</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#66d9ef>using</span> System;
<span style=color:#66d9ef>using</span> System.Collections.Generic;
<span style=color:#66d9ef>using</span> System.ComponentModel;
<span style=color:#66d9ef>using</span> System.Linq;
<span style=color:#66d9ef>using</span> System.Threading.Tasks;

<span style=color:#66d9ef>namespace</span> SyntaxAnalysisTest
{

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> IMyService
    {
        Guid GetGuid();

        <span style=color:#66d9ef>int</span>[] GenRandNumbers(<span style=color:#66d9ef>int</span> count);
<span style=color:#a6e22e>
</span><span style=color:#a6e22e>        [Description(&#34;TEST&#34;)]</span>
        <span style=color:#66d9ef>void</span> Complex(List&lt;<span style=color:#66d9ef>int</span>&gt; ints, Dictionary&lt;<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>string</span>&gt; mapping = <span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>params</span> <span style=color:#66d9ef>string</span>[] args);

    }

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyService</span> : IMyService
    {
        <span style=color:#66d9ef>public</span> Guid GetGuid() =&gt; Guid.NewGuid();

        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span>[] GenRandNumbers(<span style=color:#66d9ef>int</span> count) =&gt; <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>int</span>[]{<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>};
<span style=color:#a6e22e>
</span><span style=color:#a6e22e>        [Description(&#34;TEST&#34;)]</span>
        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> Complex(List&lt;<span style=color:#66d9ef>int</span>&gt; ints, Dictionary&lt;<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>string</span>&gt; mapping = <span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>params</span> <span style=color:#66d9ef>string</span>[] args) {}

    }
}
</code></pre></div></div><div class=post-footer></div></article></main></body></html>